# Story 2.5: Implement Advanced Retrievers

## Status
Deferred - Post-Epic 5

## Story
**As a** Developer,
**I want** To implement the specified advanced retriever methods (Multi-Query, Parent-Doc, Rerank [Cohere], Ensemble, plus Semantic Chunking interaction if applicable),
**So that** All required strategies can be evaluated.

## Acceptance Criteria
1. Each specified advanced retriever implemented and integrated into swappable architecture
2. Each is runnable within the RAG pipeline

## Tasks / Subtasks

- [ ] Task 1: Implement Multi-Query Retriever (AC: 1, 2)
  - [ ] Create MultiQueryRetriever using LangChain's MultiQueryRetriever
  - [ ] Configure to generate multiple query variations from single input
  - [ ] Integrate with existing vector store
  - [ ] Add to retriever factory function with type "multi_query"
  - [ ] Update RetrieverType literal to include "multi_query"
  - [ ] Add unit tests for multi-query retriever

- [ ] Task 2: Implement Parent Document Retriever (AC: 1, 2)
  - [ ] Create ParentDocumentRetriever using LangChain's ParentDocumentRetriever
  - [ ] Configure parent-child document relationship
  - [ ] Set up separate storage for parent documents
  - [ ] Integrate with existing vector store for child chunks
  - [ ] Add to retriever factory function with type "parent_doc"
  - [ ] Update RetrieverType literal to include "parent_doc"
  - [ ] Add unit tests for parent document retriever

- [ ] Task 3: Implement Cohere Rerank Retriever (AC: 1, 2)
  - [ ] Set up Cohere API integration for reranking
  - [ ] Create RerankRetriever using LangChain's ContextualCompressionRetriever with CohereRerank
  - [ ] Configure reranking parameters (model, top_n)
  - [ ] Wrap base retriever (naive or bm25) with reranking layer
  - [ ] Add to retriever factory function with type "rerank"
  - [ ] Update RetrieverType literal to include "rerank"
  - [ ] Add environment variable for Cohere API key
  - [ ] Add unit tests for rerank retriever (with mocked Cohere API)

- [ ] Task 4: Implement Ensemble Retriever (AC: 1, 2)
  - [ ] Create EnsembleRetriever using LangChain's EnsembleRetriever
  - [ ] Configure to combine multiple retrievers (e.g., naive + bm25)
  - [ ] Set up weighted scoring for retriever combination
  - [ ] Add to retriever factory function with type "ensemble"
  - [ ] Update RetrieverType literal to include "ensemble"
  - [ ] Add unit tests for ensemble retriever

- [ ] Task 5: Update Retriever Factory and Configuration (AC: 1)
  - [ ] Update get_retriever() factory function to support all new retriever types
  - [ ] Update RetrieverType literal type definition
  - [ ] Add configuration parameters for each new retriever type
  - [ ] Update RetrieverConfig model to support new retriever parameters
  - [ ] Ensure backward compatibility with existing retrievers
  - [ ] Add comprehensive error handling for new retriever types

- [ ] Task 6: Update RAG Pipeline Integration (AC: 2)
  - [ ] Verify RAGPipeline works with all new retriever types
  - [ ] Test retriever switching at runtime
  - [ ] Ensure proper error handling for retriever initialization failures
  - [ ] Update pipeline documentation with new retriever options
  - [ ] Add integration tests for pipeline with each new retriever

- [ ] Task 7: Update Evaluation Framework Integration (AC: 1, 2)
  - [ ] Verify EvaluationConfig supports all new retriever types
  - [ ] Test evaluation framework with each new retriever
  - [ ] Ensure caching works correctly with new retrievers
  - [ ] Update create_default_configs() if needed for advanced retrievers
  - [ ] Add evaluation integration tests

- [ ] Task 8: Add Configuration Examples and Documentation (AC: 1)
  - [ ] Document each new retriever type and its parameters
  - [ ] Provide configuration examples for each retriever
  - [ ] Document when to use each retriever type
  - [ ] Add inline code documentation
  - [ ] Update API documentation

- [ ] Task 9: Add Comprehensive Testing (AC: 1, 2)
  - [ ] Test each retriever type independently
  - [ ] Test retriever factory with all types
  - [ ] Test configuration validation for new retrievers
  - [ ] Test RAG pipeline with each retriever
  - [ ] Test evaluation framework with new retrievers
  - [ ] Test error handling for misconfigured retrievers
  - [ ] Ensure all tests pass

- [ ] Task 10: Handle Dependencies and API Keys (AC: 1)
  - [ ] Add Cohere SDK to dependencies if not present
  - [ ] Update .env.example with COHERE_API_KEY
  - [ ] Add configuration validation for required API keys
  - [ ] Document API key requirements
  - [ ] Add graceful error handling for missing API keys

## Dev Notes

### Previous Story Insights

**From Story 2.1 (Chunking & Base Retrievers):**
[Source: Story 2.1 Dev Agent Record]
- Factory pattern already implemented for retrievers
- `get_retriever(retriever_type: str, **kwargs)` factory function exists
- NaiveRetriever and BM25Retriever already implemented
- RetrieverType literal currently supports: "naive", "bm25"
- Evaluation framework ready to test new retrievers

**From Story 2.2 (Swappable Architecture):**
[Source: Story 2.2 Dev Agent Record]
- RetrieverConfig model in `backend/app/models/retriever.py`
- RAGPipeline accepts retriever_config parameter
- Configuration-driven retriever selection working
- Factory pattern makes adding new retrievers straightforward

**Key Implementation Details:**
- Current retrievers: naive (Qdrant vector similarity), bm25 (keyword-based)
- All retrievers use LangChain's BaseRetriever interface
- Factory pattern in `backend/app/rag/retrievers.py`
- Evaluation framework in `backend/app/rag/evaluation.py`

### Architecture Context

**Advanced Retriever Requirements:**
[Source: architecture/6-implementation-details.md#63, PRD Story 2.5]

**Required Advanced Retrievers:**
1. **Multi-Query Retriever** - Generates multiple query variations
2. **Parent Document Retriever** - Retrieves parent documents from child chunks
3. **Rerank Retriever (Cohere)** - Reranks results using Cohere API
4. **Ensemble Retriever** - Combines multiple retrievers

**Retriever Location:** `backend/app/rag/retrievers.py`

**Integration Points:**
- RAG Pipeline: `backend/app/rag/pipeline.py`
- Evaluation Framework: `backend/app/rag/evaluation.py`
- Configuration Models: `backend/app/models/retriever.py`

### LangChain Advanced Retrievers

**Available LangChain Components:**
[Source: architecture/3-tech-stack.md, LangChain documentation]

**Multi-Query Retriever:**
- Class: `langchain.retrievers.MultiQueryRetriever`
- Purpose: Generates multiple query variations to improve recall
- Configuration: LLM for query generation, base retriever
- Use case: When single query might miss relevant documents

**Parent Document Retriever:**
- Class: `langchain.retrievers.ParentDocumentRetriever`
- Purpose: Retrieves larger parent documents from smaller child chunks
- Configuration: Parent store, child store, splitter
- Use case: When context around matched chunk is important

**Contextual Compression with Cohere Rerank:**
- Class: `langchain.retrievers.ContextualCompressionRetriever`
- Compressor: `langchain.retrievers.document_compressors.CohereRerank`
- Purpose: Reranks retrieved documents using Cohere's reranking model
- Configuration: Cohere API key, model name, top_n
- Use case: Improving precision of retrieval results

**Ensemble Retriever:**
- Class: `langchain.retrievers.EnsembleRetriever`
- Purpose: Combines multiple retrievers with weighted scoring
- Configuration: List of retrievers, weights
- Use case: Leveraging strengths of different retrieval methods

### Cohere Rerank Integration

**Cohere API Requirements:**
[Source: architecture/3-tech-stack.md]

**API Key Configuration:**
- Environment variable: `COHERE_API_KEY`
- Add to `.env.example`
- Required for rerank retriever functionality

**Cohere Rerank Model:**
- Default model: `rerank-english-v2.0`
- Purpose: Rerank documents by relevance to query
- Parameters: top_n (number of documents to return after reranking)

**Error Handling:**
- Graceful fallback if API key missing
- Handle API rate limiting
- Handle API errors (network, authentication, etc.)

### Retriever Factory Updates

**Current Factory Function:**
[Source: backend/app/rag/retrievers.py]

**Current Signature:**
```
get_retriever(
    retriever_type: RetrieverType = "naive",
    vector_store: Optional[VectorStore] = None,
    documents: Optional[List[Document]] = None,
    top_k: int = 10,
    **kwargs,
) -> Any
```

**Required Updates:**
- Add new retriever types to RetrieverType literal
- Add type-specific parameter handling
- Add validation for required parameters per type
- Maintain backward compatibility

**New RetrieverType Values:**
- "multi_query" - Multi-Query Retriever
- "parent_doc" - Parent Document Retriever
- "rerank" - Cohere Rerank Retriever
- "ensemble" - Ensemble Retriever

### Configuration Model Updates

**RetrieverConfig Model:**
[Source: backend/app/models/retriever.py]

**Current Fields:**
- retriever_type: str
- top_k: int
- custom_params: Dict[str, Any]

**Required Updates:**
- Support new retriever types in validation
- Add type-specific parameter schemas
- Document expected parameters for each type

**Type-Specific Parameters:**

**Multi-Query:**
- llm_model: str (for query generation)
- num_queries: int (number of query variations)

**Parent-Doc:**
- parent_chunk_size: int
- child_chunk_size: int
- child_chunk_overlap: int

**Rerank:**
- base_retriever_type: str (naive or bm25)
- rerank_model: str (Cohere model name)
- rerank_top_n: int (documents after reranking)

**Ensemble:**
- retriever_types: List[str] (retrievers to combine)
- weights: List[float] (weights for each retriever)

### RAG Pipeline Integration

**Current Pipeline:**
[Source: backend/app/rag/pipeline.py]

**Pipeline Components:**
- Accepts retriever via constructor or retriever_config
- Uses retriever for document retrieval
- Passes retrieved documents to LLM for generation

**Required Verification:**
- All new retrievers work with existing pipeline
- Error handling for retriever initialization
- Proper document format from all retrievers

### Evaluation Framework Integration

**Current Evaluation:**
[Source: backend/app/rag/evaluation.py]

**EvaluationConfig:**
- Already supports retriever_type and retriever_params
- Should work with new retrievers without changes

**Required Verification:**
- New retrievers work with evaluation framework
- Caching works correctly with new retriever types
- Configuration hashing includes new parameters

### Testing Requirements

**Test Location:** `backend/tests/test_rag.py` or new file `backend/tests/test_advanced_retrievers.py`
[Source: architecture/3-tech-stack.md]

**Test Categories:**

1. **Individual Retriever Tests:**
   - Test each new retriever type independently
   - Test with valid and invalid configurations
   - Test error handling

2. **Factory Tests:**
   - Test factory with all new retriever types
   - Test parameter validation
   - Test error handling for unknown types

3. **Integration Tests:**
   - Test RAG pipeline with each new retriever
   - Test evaluation framework with new retrievers
   - Test retriever switching at runtime

4. **Configuration Tests:**
   - Test RetrieverConfig with new types
   - Test parameter validation
   - Test serialization/deserialization

**Testing Framework:** Pytest

**Mocking Strategy:**
- Mock Cohere API calls to avoid costs
- Mock LLM calls for multi-query generation
- Use small sample datasets for integration tests

### Dependencies

**Required Packages:**
[Source: architecture/3-tech-stack.md]

**Existing:**
- `langchain` - Already installed
- `langchain-community` - Already installed
- `langchain-core` - Already installed

**New (if not present):**
- `cohere` - Cohere Python SDK for reranking
- Check if already in dependencies from previous stories

**No Major New Dependencies Expected** - LangChain should include most retriever implementations

### File Structure

**Files to Modify:**
- `backend/app/rag/retrievers.py` - Add new retriever implementations
- `backend/app/models/retriever.py` - Update RetrieverConfig for new types
- `backend/.env.example` - Add COHERE_API_KEY
- `backend/tests/test_rag.py` - Add tests for new retrievers

**Files to Create (Optional):**
- `backend/tests/test_advanced_retrievers.py` - Dedicated test file for advanced retrievers

### Documentation Requirements

**Code Documentation:**
- Docstrings for all new retriever functions
- Type hints throughout
- Parameter documentation
- Usage examples

**User Documentation:**
- When to use each retriever type
- Configuration examples
- Performance characteristics
- API key requirements (for Cohere)

## Testing

**Test Location:** `backend/tests/test_rag.py` or `backend/tests/test_advanced_retrievers.py`

**Test Coverage Requirements:**
- Individual retriever functionality
- Factory function with new types
- Configuration validation
- RAG pipeline integration
- Evaluation framework integration
- Error handling
- API key validation (for Cohere)

**Testing Framework:** Pytest (per architecture/3-tech-stack.md)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation for Epic 2 | Scrum Master (Bob) |
| 2025-10-20 | 1.1 | Deferred to post-Epic 5 notebook implementation. Will be completed in E03_Advanced_Retrievers.py after full application is delivered | Product Owner (Sarah) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]
