# Story 5.4: Finalize Docker Compose & Localhost Deployment

## Status
Draft

## Story
**As a** Developer,
**I want** To finalize `docker-compose.yml` for easy `localhost` execution,
**So that** The application meets the rubric's deployment requirement and can be run with a single command.

## Acceptance Criteria
1. `docker-compose up` starts all services (Qdrant, Backend, Frontend)
2. Frontend accessible on `localhost` (port 3000)
3. Backend accessible on `localhost` (port 8000)
4. Frontend communicates with backend in Docker environment
5. Full workflow (Upload → Analyze → View → Chat) functional in Docker
6. Services start in correct order with proper dependencies
7. Documentation updated with deployment instructions

## Tasks / Subtasks

- [ ] Task 1: Review Existing Docker Compose Configuration (AC: 1)
  - [ ] Review current `docker-compose.yml` file
  - [ ] Verify Qdrant service configuration
  - [ ] Verify Backend service configuration
  - [ ] Verify Frontend service configuration (if exists)
  - [ ] Identify any missing configurations

- [ ] Task 2: Configure Frontend Service (AC: 1, 2)
  - [ ] Add frontend service to `docker-compose.yml`
  - [ ] Use frontend Dockerfile
  - [ ] Expose port 3000
  - [ ] Set environment variables for API URL
  - [ ] Configure volume mounts for development (optional)
  - [ ] Set service dependencies

- [ ] Task 3: Configure Service Dependencies (AC: 6)
  - [ ] Set Qdrant as dependency for Backend
  - [ ] Set Backend as dependency for Frontend
  - [ ] Add health checks for services
  - [ ] Configure restart policies
  - [ ] Ensure proper startup order

- [ ] Task 4: Configure Networking (AC: 4)
  - [ ] Create Docker network for services
  - [ ] Configure service names for internal communication
  - [ ] Set up backend URL for frontend (http://backend:8000)
  - [ ] Verify CORS configuration allows Docker network
  - [ ] Test inter-service communication

- [ ] Task 5: Configure Environment Variables (AC: 4)
  - [ ] Create `.env` file for Docker Compose
  - [ ] Set backend environment variables
  - [ ] Set frontend environment variables
  - [ ] Set Qdrant configuration
  - [ ] Document required environment variables

- [ ] Task 6: Optimize Docker Images (AC: 1)
  - [ ] Review backend Dockerfile for optimization
  - [ ] Review frontend Dockerfile for optimization
  - [ ] Use multi-stage builds if applicable
  - [ ] Minimize image sizes
  - [ ] Add .dockerignore files

- [ ] Task 7: Add Volume Mounts (AC: 1)
  - [ ] Configure volume for Qdrant data persistence
  - [ ] Configure volume for uploaded documents
  - [ ] Configure volumes for development (optional)
  - [ ] Document volume purposes

- [ ] Task 8: Create Makefile Targets (AC: 7)
  - [ ] Add `make up` - Start all services
  - [ ] Add `make down` - Stop all services
  - [ ] Add `make build` - Build all images
  - [ ] Add `make logs` - View service logs
  - [ ] Add `make clean` - Clean up volumes
  - [ ] Document Makefile usage

- [ ] Task 9: Test Full Deployment (AC: 1-5)
  - [ ] Run `docker-compose up` from clean state
  - [ ] Verify all services start successfully
  - [ ] Access frontend at http://localhost:3000
  - [ ] Access backend at http://localhost:8000
  - [ ] Test upload workflow
  - [ ] Test analysis workflow
  - [ ] Test results display
  - [ ] Test chat functionality
  - [ ] Verify data persistence

- [ ] Task 10: Update Documentation (AC: 7)
  - [ ] Update README.md with deployment instructions
  - [ ] Document prerequisites (Docker, Docker Compose)
  - [ ] Document environment setup
  - [ ] Document how to start/stop services
  - [ ] Document how to view logs
  - [ ] Document troubleshooting steps
  - [ ] Add architecture diagram (optional)

## Dev Notes

### Architecture Context

**Deployment Requirement:**
[Source: PRD Epic 5]
- Application must run via Docker Compose
- Accessible on localhost
- Single command to start: `docker-compose up`

**Services:**
1. **Qdrant** - Vector database
2. **Backend** - FastAPI application
3. **Frontend** - Next.js application

### Docker Compose Structure

**Expected Services Configuration:**

```yaml
version: '3.8'

services:
  qdrant:
    # Vector database service
    
  backend:
    # FastAPI backend service
    depends_on:
      - qdrant
    
  frontend:
    # Next.js frontend service
    depends_on:
      - backend
```

### Port Mappings

**Standard Ports:**
- Frontend: 3000 (host) → 3000 (container)
- Backend: 8000 (host) → 8000 (container)
- Qdrant: 6333 (host) → 6333 (container)

### Environment Variables

**Backend Environment:**
- `QDRANT_HOST=qdrant`
- `QDRANT_PORT=6333`
- `OPENAI_API_KEY=${OPENAI_API_KEY}`
- Other backend configuration

**Frontend Environment:**
- `NEXT_PUBLIC_API_BASE_URL=http://localhost:8000`
- Note: Use localhost for browser access, not Docker service name

### Service Dependencies

**Startup Order:**
1. Qdrant starts first
2. Backend waits for Qdrant to be ready
3. Frontend waits for Backend to be ready

**Health Checks:**
- Qdrant: Check port 6333 availability
- Backend: Check /health endpoint
- Frontend: Check port 3000 availability

### Volume Configuration

**Persistent Volumes:**
- Qdrant data: `./qdrant_data:/qdrant/storage`
- Uploaded documents: `./data:/app/data`

**Development Volumes (Optional):**
- Backend code: `./backend:/app`
- Frontend code: `./frontend:/app`

### Network Configuration

**Docker Network:**
- Create custom bridge network
- All services on same network
- Services communicate via service names

**Internal URLs:**
- Backend to Qdrant: `http://qdrant:6333`
- Frontend to Backend (server-side): `http://backend:8000`
- Frontend to Backend (client-side): `http://localhost:8000`

### Dockerfile Requirements

**Backend Dockerfile:**
- Based on Python image
- Install dependencies with uv
- Copy application code
- Expose port 8000
- Run with uvicorn

**Frontend Dockerfile:**
- Based on Node image
- Install dependencies
- Build Next.js application
- Expose port 3000
- Run with next start

### Makefile Targets

**Suggested Targets:**
```makefile
up:
    docker-compose up -d

down:
    docker-compose down

build:
    docker-compose build

logs:
    docker-compose logs -f

clean:
    docker-compose down -v
```

### Testing Checklist

**Deployment Testing:**
1. Clean environment (remove old containers/volumes)
2. Run `docker-compose up`
3. Wait for all services to start
4. Access frontend at http://localhost:3000
5. Upload a document
6. Trigger analysis
7. View results
8. Test chat
9. Verify data persists after restart

### Common Issues

**Troubleshooting:**
- Services not starting: Check logs with `docker-compose logs`
- Frontend can't reach backend: Check CORS configuration
- Qdrant connection fails: Verify service name and port
- Port conflicts: Ensure ports 3000, 8000, 6333 are available
- Permission issues: Check volume mount permissions

### Documentation Requirements

**README.md Should Include:**
1. Prerequisites (Docker, Docker Compose versions)
2. Quick start instructions
3. Environment variable setup
4. How to start services
5. How to access application
6. How to stop services
7. How to view logs
8. Troubleshooting guide

### Dependencies

**Depends On:**
- Story 1.1 (Initial Docker setup)
- Story 5.0 (Backend API endpoints)
- Story 5.1, 5.2 (Frontend screens)
- Story 5.3 (Frontend-Backend integration)

**Enables:**
- Story 5.5 (Final deliverables - working deployment)

### Existing Configuration

**Review These Files:**
- `docker-compose.yml` (root)
- `backend/Dockerfile`
- `frontend/Dockerfile`
- `Makefile` (root)
- `.env.example`

Update as needed to ensure full system works together.

## Testing

**Manual Testing Checklist:**
- [ ] `docker-compose up` starts all services
- [ ] No errors in service logs
- [ ] Frontend accessible at localhost:3000
- [ ] Backend accessible at localhost:8000
- [ ] Qdrant accessible at localhost:6333
- [ ] Upload document works
- [ ] Analysis completes successfully
- [ ] Results display correctly
- [ ] Chat works
- [ ] Data persists after `docker-compose down` and `up`
- [ ] Services restart correctly
- [ ] Logs are accessible

**Clean Environment Testing:**
- [ ] Remove all containers: `docker-compose down -v`
- [ ] Remove all images: `docker-compose down --rmi all`
- [ ] Start from scratch: `docker-compose up --build`
- [ ] Verify everything works

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial story creation for Epic 5 | Scrum Master (Bob) |

## Dev Agent Record
_To be filled by Dev Agent during implementation_

### Agent Model Used
_To be filled by Dev Agent_

### Debug Log References
_To be filled by Dev Agent_

### Completion Notes List
_To be filled by Dev Agent_

### File List
_To be filled by Dev Agent_

## QA Results
_To be filled by QA Agent_
